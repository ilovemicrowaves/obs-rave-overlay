<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=1920, height=1080">
  <title>Now Playing - OBS Overlay</title>
  <link rel="stylesheet" href="../styles/base.css">
  <link rel="stylesheet" href="../styles/animations.css">
  <style>
    body {
      width: 420px;
      height: 180px;
    }

    .now-playing {
      display: flex;
      gap: 16px;
      width: 100%;
      height: 100%;
    }

    .album-art-container {
      position: relative;
      width: 148px;
      height: 148px;
      flex-shrink: 0;
    }

    .album-art-glow {
      position: absolute;
      inset: -4px;
      border-radius: 12px;
      background: linear-gradient(135deg, var(--color-primary), var(--color-secondary));
      animation: pulse var(--animation-speed) ease-in-out infinite;
      opacity: 0.6;
    }

    .album-art {
      position: relative;
      width: 100%;
      height: 100%;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
    }

    .album-art img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .track-info {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
      gap: 8px;
      min-width: 0;
    }

    .track-name {
      font-size: 20px;
      font-weight: 700;
      color: var(--color-text);
      line-height: 1.3;
      overflow: hidden;
      text-overflow: ellipsis;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
    }

    .artist-name {
      font-size: 15px;
      color: var(--color-text-secondary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .track-meta {
      display: flex;
      gap: 12px;
      align-items: center;
      margin-top: 4px;
      flex-wrap: wrap;
    }

    .genre-badge {
      display: inline-flex;
      align-items: center;
      padding: 5px 12px;
      background: linear-gradient(135deg, var(--color-primary), var(--color-secondary));
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .bpm-display {
      font-size: 13px;
      font-weight: 600;
      color: var(--color-accent);
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .bpm-icon {
      width: 12px;
      height: 12px;
      background: var(--color-accent);
      border-radius: 50%;
      animation: heartbeat 1s ease-in-out infinite;
    }

    @keyframes heartbeat {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.2); }
    }

    .progress-bar-container {
      margin-top: 8px;
    }

    .progress-time {
      display: flex;
      justify-content: space-between;
      font-size: 10px;
      color: var(--color-text-secondary);
      margin-top: 4px;
      font-variant-numeric: tabular-nums;
    }

    .loading-container {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 100%;
      height: 100%;
    }

    .not-playing {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      width: 100%;
      height: 100%;
      color: var(--color-text-secondary);
      text-align: center;
      gap: 12px;
    }

    .not-playing-icon {
      font-size: 48px;
      opacity: 0.3;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="module">
    import { h, render } from 'https://esm.sh/preact@10.19.3';
    import { useState, useEffect } from 'https://esm.sh/preact@10.19.3/hooks';
    import htm from 'https://esm.sh/htm@3.1.1';
    import { EventBus, EventTypes } from '../shared/lib/event-bus.js';

    const html = htm.bind(h);

    function formatTime(ms) {
      const seconds = Math.floor(ms / 1000);
      const mins = Math.floor(seconds / 60);
      const secs = seconds % 60;
      return `${mins}:${secs.toString().padStart(2, '0')}`;
    }

    function NowPlaying() {
      const [trackData, setTrackData] = useState(null);
      const [theme, setTheme] = useState(null);
      const [progress, setProgress] = useState(0);
      const [error, setError] = useState(null);
      const [themeClass, setThemeClass] = useState('theme-default');
      const [intensityClass, setIntensityClass] = useState('intensity-medium');

      useEffect(() => {
        const eventBus = new EventBus();

        // Listen to Spotify track updates
        const unsubscribeTrack = eventBus.on(EventTypes.SPOTIFY_TRACK_UPDATE, (data) => {
          console.log('[Now Playing] Track update:', data);
          setTrackData(data);
          setError(null);
        });

        // Listen to Spotify errors
        const unsubscribeError = eventBus.on(EventTypes.SPOTIFY_ERROR, (err) => {
          console.error('[Now Playing] Spotify error:', err);
          setError(err.message);
        });

        // Listen to theme updates
        const unsubscribeTheme = eventBus.on(EventTypes.THEME_UPDATE, (themeData) => {
          console.log('[Now Playing] Theme update received:', themeData);
          console.log('[Now Playing] Setting classes:', `theme-${themeData.genre}`, `intensity-${themeData.intensityClass}`);
          console.log('[Now Playing] Beat duration:', themeData.effects.beatDuration);

          setTheme(themeData);

          // Set dance classes
          setThemeClass(`theme-${themeData.genre}`);
          setIntensityClass(`intensity-${themeData.intensityClass}`);

          // Apply theme to document
          const root = document.documentElement;
          Object.entries(themeData.colors).forEach(([key, value]) => {
            root.style.setProperty(`--color-${key}`, value);
            console.log(`[Now Playing] Set CSS var --color-${key}:`, value);
          });
          Object.entries(themeData.effects).forEach(([key, value]) => {
            const cssKey = `--${key.replace(/([A-Z])/g, '-$1').toLowerCase()}`;
            root.style.setProperty(cssKey, value);
            console.log(`[Now Playing] Set CSS var ${cssKey}:`, value);
          });

          // Log final widget classes after state update
          setTimeout(() => {
            const widget = document.querySelector('.now-playing');
            if (widget) {
              console.log('[Now Playing] Widget classes:', widget.className);
              console.log('[Now Playing] Computed animation:', window.getComputedStyle(widget).animation);
            }
          }, 100);
        });

        // Announce widget ready
        eventBus.emit(EventTypes.WIDGET_READY, {
          widget: 'now-playing',
          timestamp: Date.now(),
        });

        return () => {
          eventBus.disconnect();
        };
      }, []);

      // Update progress bar
      useEffect(() => {
        if (!trackData || !trackData.isPlaying) return;

        const interval = setInterval(() => {
          const elapsed = Date.now() - trackData.timestamp;
          const currentProgress = trackData.track.progress_ms + elapsed;
          const percentage = (currentProgress / trackData.track.duration_ms) * 100;
          setProgress(Math.min(percentage, 100));
        }, 100);

        return () => clearInterval(interval);
      }, [trackData]);

      if (error) {
        return html`
          <div class="widget">
            <div class="error">
              <strong>Spotify Error:</strong> ${error}
              ${error === 'Not authenticated' && html`
                <div style="margin-top: 8px;">
                  <a href="/auth/spotify/login" style="color: #10b981;">Authenticate Spotify</a>
                </div>
              `}
            </div>
          </div>
        `;
      }

      if (!trackData) {
        return html`
          <div class="widget">
            <div class="loading-container">
              <div class="loading">
                <div class="spinner"></div>
                <span>Waiting for music...</span>
              </div>
            </div>
          </div>
        `;
      }

      if (!trackData.isPlaying) {
        return html`
          <div class="widget">
            <div class="not-playing">
              <div class="not-playing-icon">‚è∏</div>
              <div>Playback paused</div>
            </div>
          </div>
        `;
      }

      const { track, features, genre } = trackData;
      const progressTime = formatTime(track.progress_ms);
      const durationTime = formatTime(track.duration_ms);

      return html`
        <div class="widget widget-glow widget-dance now-playing ${themeClass} ${intensityClass}">
          <div class="album-art-container">
            <div class="album-art-glow"></div>
            <div class="album-art">
              <img
                src=${track.albumArt}
                alt=${track.album}
                crossorigin="anonymous"
              />
            </div>
          </div>

          <div class="track-info">
            <div class="track-name">${track.name}</div>
            <div class="artist-name">${track.artist}</div>

            <div class="track-meta">
              <span class="genre-badge">${genre || 'Music'}</span>
              ${features.bpm && html`
                <span class="bpm-display">
                  <span class="bpm-icon"></span>
                  ${features.bpm} BPM
                </span>
              `}
            </div>

            <div class="progress-bar-container">
              <div class="progress-bar">
                <div class="progress-fill" style="width: ${progress}%"></div>
              </div>
              <div class="progress-time">
                <span>${progressTime}</span>
                <span>${durationTime}</span>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    render(html`<${NowPlaying} />`, document.getElementById('root'));
  </script>
</body>
</html>
